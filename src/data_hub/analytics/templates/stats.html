{% load static %}

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Monthly Stats</title>
        <link href="https://use.typekit.net/rcc6rge.css" rel="stylesheet" />
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            html,
            body {
                font-family: pf-grand-gothik-variable, sans-serif;
                width: 100vw;
                overflow-x: hidden;
            }

            .logo {
                width: 100%;
                max-width: 1200px;
                margin: auto;
            }

            .logo img {
                width: 200px;
            }

            h1 {
                text-align: center;
            }

            .centered {
                margin: 50px auto;
            }

            .totals {
                text-align: center;
                margin-bottom: 10px;
            }

            .totals span {
                font-weight: bold;
            }

            .value {
                display: grid;
                justify-content: center;
                margin: 50px 0;
            }

            .inner-value {
                display: flex;
            }

            .bubble {
                background-color: #0379bc;
                width: 150px;
                height: 150px;
                border-radius: 75px;
                display: grid;
                grid-template-columns: auto;
                text-align: center;
                color: white;
            }

            .bubble .total {
                font-weight: bold;
                font-size: 24px;
            }

            .bubble img {
                width: 24px;
                margin: auto;
                filter: invert(1);
            }

            .times {
                width: 100px;
                display: grid;
                grid-template-columns: auto;
                text-align: center;
                margin: 10px 0;
            }

            .times img {
                width: 24px;
                margin: auto;
            }

            .times div {
                font-size: 10px;
            }

            form {
                border: 1px solid black;
                width: 800px;
                margin: 50px auto;
            }

            .timeframe {
                padding: 20px;
                text-align: center;
            }

            .timeframe span {
                margin: 0 20px;
            }

            .submit-form input {
                border: none;
                background: #0379bc;
                padding: 10px;
                font-size: 18px;
                color: white;
            }

            .chart-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                max-width: 1400px;
                column-gap: 30px;
                row-gap: 30px;
                margin: 30px auto;
            }

            .chart {
                width: 100%;
            }

            .line-chart-container {
                margin: 80px auto;
                max-width: 1000px;
                display: grid;
                grid-template-columns: 2fr 7fr;
            }

            #service-types div {
                margin: 20px;
                display: grid;
                grid-template-columns: 30px 150px;
                grid-row-gap: 5px;
            }

            @media screen and (max-width: 800px) {
                .chart-container {
                    display: grid;
                    grid-template-columns: 1fr;
                    max-width: 700px;
                    row-gap: 30px;
                    margin: 30px auto;
                }

                form {
                    max-width: 700px;
                }
            }
        </style>
    </head>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>

        <!-- prettier-ignore -->
        <div class="logo centered">
            <img src="{% static "analytics/TxGIO_Primary_Horizontal_Digital_RGB_WebOptimized.png" %}" /> 
        </div>

        {% if request.GET.start_date %}
        <!-- keep the Prettier extension from reformating the following tag on save -->
        <!-- prettier-ignore -->
        <h1>
            DataHub Statistics
        </h1>
        {% else %}
        <!-- prettier-ignore -->
        <h1>
            DataHub Statistics for Current Month
        </h1>
        {% endif %}

        <form action="/analytics/get_monthly_stats/" method="GET">
            <div class="timeframe">
                <span>
                    Start date
                    <input
                        type="date"
                        name="start_date"
                        value="{{ request.GET.start_date }}"
                    />
                </span>
                <span>
                    End date
                    <input
                        type="date"
                        name="end_date"
                        value="{{ request.GET.end_date }}"
                    />
                </span>
                <span class="submit-form">
                    <input type="submit" value="Refresh" />
                </span>
            </div>
        </form>

        <div class="summary">
            <div class="totals">
                <span>Total Downloads :</span>&nbsp;{{total_downloads}}
            </div>
            <div class="totals">
                <span> Successful Data Downloads : </span
                >&nbsp;{{total_success_data}}
            </div>
            <div class="totals">
                <span> Successful Map Downloads : </span
                >&nbsp;{{total_success_map}}
            </div>
            <div class="totals">
                <span> Failed Downloads : </span>&nbsp;{{total_errors}}
            </div>
        </div>

        <!-- prettier-ignore -->
        <div class="value">
            <div class="inner-value">
                <div class="bubble">
                    <img src="{% static "analytics/interrogation.png" %}" /> 
                    <div class="total">{{total_success}}</div>
                    <div class="explanation">downloads responsive to PIR needs</div>
                </div>
                <div class="times">
                    <img src="{% static "analytics/cross-small.png" %}" />
                    <div>multiply by estimated time to complete (~3 hours)</div>
                </div>
                <div class="bubble">
                    <img src="{% static "analytics/clock-two.png" %}" /> 
                    <div class="total">{{hours_saved}}</div>
                    <div class="explanation">hours saved</div>
                </div>
                <div class="times">
                    <img src="{% static "analytics/cross-small.png" %}" />
                    <div>multiply by employee average hourly salary (~ $26.66)</div>
                </div>
                <div class="bubble">
                    <img src="{% static "analytics/piggy-bank.png" %}" /> 
                    <div class="total">{{dollars_saved}}</div>
                    <div class="explanation">dollars saved</div>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart">
                <canvas id="count-by-key-chart"></canvas>
            </div>
            <div class="chart">
                <canvas id="count-by-collection-chart"></canvas>
            </div>
            <div class="chart">
                <canvas id="count-by-historic-chart"></canvas>
            </div>
            <div class="chart">
                <canvas id="count-by-map-chart"></canvas>
            </div>
            <div class="chart">
                <canvas id="count-by-resource-type-chart"></canvas>
            </div>
        </div>
        
        <div class="line-chart-container">
            <div id="service-types">
                <!-- rows are created in the JS below -->
            </div>
            <div>
                <canvas id="test-line-chart"></canvas>
            <div>
        </div>
        

        <script>
            const buildChart = (chartId, chartLabel, labels, data) => {
                const ctx = document.getElementById(chartId);
                new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels,
                        datasets: [
                            {
                                // label: chartLabel,
                                data,
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                            },
                        },
                        indexAxis: "y",
                        plugins: {
                            legend: {
                                display: false,
                            },
                            title: {
                                display: true,
                                text: chartLabel,
                            },
                        },
                    },
                });
            };

            const buildLineChart = (chartId, chartLabel, labels, datasets) => {
                const ctx = document.getElementById(chartId);
                if (window.lineChart) {
                    window.lineChart.destroy()
                }
                window.lineChart = new Chart(ctx, {
                    type: "line",
                    data: {
                        labels,
                        datasets,
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });                
            }

            window.services = [
                {'Address_Points': false}, 
                {'Basemap': false}, 
                {'Bathymetry': false}, 
                {'FDST': false}, 
                {'Geologic_Database': false}, 
                {'Hydrography': false}, 
                {'Hypsography': false}, 
                {'Parcels': false}
                ]
            console.log(window.services)
            const updateServiceType = async (serviceType) => {
                console.log(window.services)

                window.services.forEach(service => {
                    Object.keys(service).forEach(key => {
                        if (key == serviceType) {
                            service[key] = !service[key]
                        }
                    })
                })

                const servicesParam = JSON.stringify(window.services)
                const queryParams = window.location.search.split('?')[1]
                const convertDateToTime = dateString => {
                    // assumes date string in YYYY-MM-DD format
                    const [year, month, day] = dateString.split('-')
                    return new Date(year, month - 1, day).getTime()
                }
                let startDate = ""
                let endDate = ""
                if (queryParams) {
                    const queryParamsArray = queryParams.split('&')
                    queryParamsArray.forEach((param => {
                        if (param.startsWith('start_date')) {
                            startDate = convertDateToTime(param.split('=')[1])
                        }
                        if (param.startsWith('end_date')) {
                            endDate = convertDateToTime(param.split('=')[1])
                        }
                    }))
                }
                const response = await fetch(
                    `http://localhost:8000/analytics/get_stats_from_arcgis/?services=${servicesParam}&start_date=${startDate}&end_date=${endDate}`
                )

                const result = await response.json()
                console.log(result)
                let datasets = []
                console.log("result.report['report-data'][0]", result.report['report-data'][0])
                result.report['report-data'][0].forEach((dataset, index) => {
                    console.log('dataset', dataset)
                    console.log('index', index)
                    let legendLabel = dataset.resourceURI.split('/')[1]
                    if (!legendLabel) legendLabel = 'Site (root)'
                    datasets.push({ data: dataset.data, label: legendLabel, borderWidth: 1 })
                })
                //let data = result.report['report-data'][0][0].data
                let labels = result.report['time-slices'].map(time => new Date(time).toDateString())
                buildLineChart("test-line-chart", "this is a test", labels, datasets)

            }
            updateServiceType()
            const serviceTypesDiv = document.getElementById('service-types');
            window.services.forEach(serviceObj => {
                const service = Object.keys(serviceObj)[0]
                const label = document.createElement('label')
                label.setAttribute('for', service)
                const labelValue = document.createTextNode(service)
                label.appendChild(labelValue)
                const checkbox = document.createElement('input')
                checkbox.setAttribute('type', 'checkbox')
                checkbox.setAttribute('id', service)
                const serviceDiv = document.createElement('div')
                checkbox.addEventListener("change", () => {updateServiceType(service)})
                serviceDiv.appendChild(checkbox)
                serviceDiv.appendChild(label)
                serviceTypesDiv.appendChild(serviceDiv)
            })
            
            console.log('ever here')

            console.log(serviceTypesDiv.children)
            for (const child of serviceTypesDiv.children) {
                console.log(child)
                console.log(child.tagName)
                if (child.tagName == 'INPUT') {
                    child.addEventListener("change", () => {console.log('ever here'); updateServiceType(child.id);})
                }

            }
            
        </script>

        <script type="text/javascript">
            buildChart("count-by-key-chart", "Top 10 Successfully Downloaded Files", [
                {% for item in count_by_key %}
                "{% autoescape off %}{{item.0}}{% endautoescape %}",
            {% endfor %}
            ], [
            {% for item in count_by_key %}
            {{item.1}},
            {% endfor %}
            ])
        </script>
        <script type="text/javascript">
                buildChart("count-by-collection-chart", "Top 10 Successfully Downloaded Data Collections (Historic Imagery Included)", [
                    {% for item in count_by_collection %}
                "{% autoescape off %}{{item.0}}{% endautoescape %}",
                {% endfor %}
            ], [
                {% for item in count_by_collection %}
                {{item.1}},
                {% endfor %}
            ])
        </script>
        <script type="text/javascript">
            buildChart("count-by-historic-chart", "Top 10 Successfully Downloaded Historic Imagery Data Collections", [
            {% for item in count_by_historic %}
            "{% autoescape off %}{{item.0}}{% endautoescape %}",
            {% endfor %}
            ], [
            {% for item in count_by_historic %}
            {{item.1}},
            {% endfor %}
            ])
        </script>
        <script type="text/javascript">
            buildChart("count-by-map-chart", "Top 10 Successfully Downloaded Maps", [
            {% for item in count_by_map %}
            "{% autoescape off %}{{item.0}}{% endautoescape %}",
            {% endfor %}
            ], [
                {% for item in count_by_map %}
            {{item.1}},
            {% endfor %}
            ])
        </script>
        <script type="text/javascript">
            buildChart("count-by-resource-type-chart", "Total Successfully Downloaded Count by resource_type", [
            {% for item in count_by_resource_type %}
            "{% autoescape off %}{{item.0}}{% endautoescape %}",
            {% endfor %}
            ], [
                {% for item in count_by_resource_type %}
                {{item.1}},
            {% endfor %}
            ])
        </script>
    </body>
</html>
